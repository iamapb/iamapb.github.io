<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="binbin"><meta name="copyright" content="binbin"><meta name="generator" content="Hexo 4.2.1"><meta name="theme" content="hexo-theme-yun"><title>微信 | 随便写点</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;family=Source+Code+Pro&amp;display=swap" media="none" onload="this.media='all'"><script src="//at.alicdn.com/t/font_1140697_pem9yni52s.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"root":"/","title":"斌斌小站","version":"0.9.1","anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="微信支付 (比较乱 只是给个参考)首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)微信支付公众方法1第三方微信的各种支付 退款接口com.alibaba.fastjson.JSONObject;12345678910111213141516171819202122232425262728293031323334353637383940">
<meta property="og:type" content="article">
<meta property="og:title" content="微信">
<meta property="og:url" content="http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/index.html">
<meta property="og:site_name" content="随便写点">
<meta property="og:description" content="微信支付 (比较乱 只是给个参考)首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)微信支付公众方法1第三方微信的各种支付 退款接口com.alibaba.fastjson.JSONObject;12345678910111213141516171819202122232425262728293031323334353637383940">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-06-29T14:34:47.000Z">
<meta property="article:modified_time" content="2020-07-01T13:44:22.262Z">
<meta property="article:author" content="binbin">
<meta name="twitter:card" content="summary"></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script defer src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="binbin"><img width="96" loading="lazy" src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJx8aJMTicIKEcWB3sltRib2jUSopeIrialsGfcpBHAE3jPs4raImlQCCw7YAIZaq5OaKkwoicRSMcG5Q/132" alt="binbin"></a><div class="site-author-name"><a href="/about/">binbin</a></div><a class="site-name" href="/about/site.html">随便写点</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">0</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" href="https://yun.yunyoujun.cn" target="_blank" rel="noopener" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=1174437797&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/iamapb/iamapb.github.io" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#微信支付-比较乱-只是给个参考"><span class="toc-number">1.</span> <span class="toc-text">微信支付 (比较乱 只是给个参考)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#首先获取-appid-appSecret-微信公众平台申请的小程序可以获取-mchId-微信商户号可以获得"><span class="toc-number">1.1.</span> <span class="toc-text">首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#微信支付公众方法"><span class="toc-number">1.2.</span> <span class="toc-text">微信支付公众方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1第三方微信的各种支付-退款接口"><span class="toc-number">1.2.1.</span> <span class="toc-text">1第三方微信的各种支付 退款接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-微信第三方转换工具"><span class="toc-number">1.2.2.</span> <span class="toc-text">2 微信第三方转换工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-发送请求接口"><span class="toc-number">1.2.3.</span> <span class="toc-text">3  发送请求接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-配置接口"><span class="toc-number">1.2.4.</span> <span class="toc-text">4  配置接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-创建微信支付的各种配置参数"><span class="toc-number">1.2.5.</span> <span class="toc-text">5 创建微信支付的各种配置参数</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="binbin"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="随便写点"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">微信</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2020-06-29 22:34:47" itemprop="dateCreated datePublished" datetime="2020-06-29T22:34:47+08:00">2020-06-29</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2020-07-01 21:44:22" itemprop="dateModified" datetime="2020-07-01T21:44:22+08:00">2020-07-01</time></div><div class="post-classify"></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content post-markdown"><h2 id="微信支付-比较乱-只是给个参考"><a href="#微信支付-比较乱-只是给个参考" class="headerlink" title="微信支付 (比较乱 只是给个参考)"></a>微信支付 (比较乱 只是给个参考)</h2><h3 id="首先获取-appid-appSecret-微信公众平台申请的小程序可以获取-mchId-微信商户号可以获得"><a href="#首先获取-appid-appSecret-微信公众平台申请的小程序可以获取-mchId-微信商户号可以获得" class="headerlink" title="首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)"></a>首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)</h3><h3 id="微信支付公众方法"><a href="#微信支付公众方法" class="headerlink" title="微信支付公众方法"></a>微信支付公众方法</h3><h4 id="1第三方微信的各种支付-退款接口"><a href="#1第三方微信的各种支付-退款接口" class="headerlink" title="1第三方微信的各种支付 退款接口"></a>1第三方微信的各种支付 退款接口</h4><figure class="highlight plain"><figcaption><span>com.alibaba.fastjson.JSONObject;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.springframework.core.io.ClassPathResource;</span><br><span class="line">   </span><br><span class="line">import javax.net.ssl.HttpsURLConnection;</span><br><span class="line">import javax.net.ssl.KeyManagerFactory;</span><br><span class="line">import javax.net.ssl.SSLContext;</span><br><span class="line">import javax.net.ssl.TrustManager;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.net.HttpURLConnection;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.security.KeyStore;</span><br><span class="line">import java.security.SecureRandom;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">   </span><br><span class="line">@Slf4j</span><br><span class="line">public class WXPay &#123;</span><br><span class="line">private WXPayConfig config;</span><br><span class="line">private WXPayConstants.SignType signType;</span><br><span class="line">private boolean useSandbox;</span><br><span class="line">   </span><br><span class="line">public WXPay(final WXPayConfig config) &#123;</span><br><span class="line">    this(config, WXPayConstants.SignType.MD5, false);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public WXPay(final WXPayConfig config, final WXPayConstants.SignType signType) &#123;</span><br><span class="line">    this(config, signType, false);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public WXPay(final WXPayConfig config, final WXPayConstants.SignType signType, final boolean useSandbox) &#123;</span><br><span class="line">    this.config &#x3D; config;</span><br><span class="line">    this.signType &#x3D; signType;</span><br><span class="line">    this.useSandbox &#x3D; useSandbox;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; fillRequestData(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    reqData.put(&quot;appid&quot;, this.config.getAppID());</span><br><span class="line">    reqData.put(&quot;mch_id&quot;, this.config.getMchID());</span><br><span class="line">    if (StringUtils.isNotEmpty(this.config.getSubMchId())) &#123;</span><br><span class="line">        reqData.put(&quot;sub_mch_id&quot;, this.config.getSubMchId());</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    reqData.put(&quot;nonce_str&quot;, WXPayUtil.generateNonceStr());</span><br><span class="line">    if (WXPayConstants.SignType.MD5.equals(this.signType)) &#123;</span><br><span class="line">        reqData.put(&quot;sign_type&quot;, &quot;MD5&quot;);</span><br><span class="line">    &#125; else if (WXPayConstants.SignType.HMACSHA256.equals(this.signType)) &#123;</span><br><span class="line">        reqData.put(&quot;sign_type&quot;, &quot;HMAC-SHA256&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    reqData.put(&quot;sign&quot;, WXPayUtil.generateSignature(reqData, this.config.getKey(), this.signType));</span><br><span class="line">    return reqData;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public boolean isResponseSignatureValid(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return WXPayUtil.isSignatureValid(reqData, this.config.getKey(), this.signType);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public boolean isPayResultNotifySignatureValid(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    String signTypeInData &#x3D; (String)reqData.get(&quot;sign_type&quot;);</span><br><span class="line">    WXPayConstants.SignType signType;</span><br><span class="line">    if (signTypeInData &#x3D;&#x3D; null) &#123;</span><br><span class="line">        signType &#x3D; WXPayConstants.SignType.MD5;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        signTypeInData &#x3D; signTypeInData.trim();</span><br><span class="line">        if (signTypeInData.length() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            signType &#x3D; WXPayConstants.SignType.MD5;</span><br><span class="line">        &#125; else if (&quot;MD5&quot;.equals(signTypeInData)) &#123;</span><br><span class="line">            signType &#x3D; WXPayConstants.SignType.MD5;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (!&quot;HMAC-SHA256&quot;.equals(signTypeInData)) &#123;</span><br><span class="line">                throw new Exception(String.format(&quot;Unsupported sign_type: %s&quot;, signTypeInData));</span><br><span class="line">            &#125;</span><br><span class="line">   </span><br><span class="line">            signType &#x3D; WXPayConstants.SignType.HMACSHA256;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    return WXPayUtil.isSignatureValid(reqData, this.config.getKey(), signType);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public String requestWithoutCert(String strUrl, Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String UTF8 &#x3D; &quot;UTF-8&quot;;</span><br><span class="line">    String reqBody &#x3D; WXPayUtil.mapToXml(reqData);</span><br><span class="line">    URL httpUrl &#x3D; new URL(strUrl);</span><br><span class="line">    HttpURLConnection httpURLConnection &#x3D; (HttpURLConnection)httpUrl.openConnection();</span><br><span class="line">    httpURLConnection.setDoOutput(true);</span><br><span class="line">    httpURLConnection.setRequestMethod(&quot;POST&quot;);</span><br><span class="line">    httpURLConnection.setConnectTimeout(connectTimeoutMs);</span><br><span class="line">    httpURLConnection.setReadTimeout(readTimeoutMs);</span><br><span class="line">    httpURLConnection.connect();</span><br><span class="line">    OutputStream outputStream &#x3D; httpURLConnection.getOutputStream();</span><br><span class="line">    outputStream.write(reqBody.getBytes(UTF8));</span><br><span class="line">    InputStream inputStream &#x3D; httpURLConnection.getInputStream();</span><br><span class="line">    BufferedReader bufferedReader &#x3D; new BufferedReader(new InputStreamReader(inputStream, UTF8));</span><br><span class="line">    StringBuffer stringBuffer &#x3D; new StringBuffer();</span><br><span class="line">    String line &#x3D; null;</span><br><span class="line">   </span><br><span class="line">    while((line &#x3D; bufferedReader.readLine()) !&#x3D; null) &#123;</span><br><span class="line">        stringBuffer.append(line).append(&quot;\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String resp &#x3D; stringBuffer.toString();</span><br><span class="line">    if (stringBuffer !&#x3D; null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            bufferedReader.close();</span><br><span class="line">        &#125; catch (IOException var18) &#123;</span><br><span class="line">            var18.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    if (inputStream !&#x3D; null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; catch (IOException var17) &#123;</span><br><span class="line">            var17.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    if (outputStream !&#x3D; null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125; catch (IOException var16) &#123;</span><br><span class="line">            var16.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    return resp;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public String requestWithCert(String strUrl, Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String UTF8 &#x3D; &quot;UTF-8&quot;;</span><br><span class="line">    String reqBody &#x3D; WXPayUtil.mapToXml(reqData);</span><br><span class="line">    URL httpUrl &#x3D; new URL(strUrl);</span><br><span class="line">    char[] password &#x3D; this.config.getMchID().toCharArray();</span><br><span class="line">    InputStream certStream &#x3D; new ClassPathResource(&quot;wxpay&#x2F;apiclient_cert.p12&quot;).getInputStream();</span><br><span class="line">    KeyStore ks &#x3D; KeyStore.getInstance(&quot;PKCS12&quot;);</span><br><span class="line">    ks.load(certStream, password);</span><br><span class="line">    KeyManagerFactory kmf &#x3D; KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</span><br><span class="line">    kmf.init(ks, password);</span><br><span class="line">    SSLContext sslContext &#x3D; SSLContext.getInstance(&quot;TLS&quot;);</span><br><span class="line">    sslContext.init(kmf.getKeyManagers(), (TrustManager[])null, new SecureRandom());</span><br><span class="line">    HttpsURLConnection.setDefaultSSLSocketFactory(sslContext.getSocketFactory());</span><br><span class="line">    HttpURLConnection httpURLConnection &#x3D; (HttpURLConnection)httpUrl.openConnection();</span><br><span class="line">    httpURLConnection.setDoOutput(true);</span><br><span class="line">    httpURLConnection.setRequestMethod(&quot;POST&quot;);</span><br><span class="line">    httpURLConnection.setConnectTimeout(connectTimeoutMs);</span><br><span class="line">    httpURLConnection.setReadTimeout(readTimeoutMs);</span><br><span class="line">    httpURLConnection.connect();</span><br><span class="line">    OutputStream outputStream &#x3D; httpURLConnection.getOutputStream();</span><br><span class="line">    outputStream.write(reqBody.getBytes(UTF8));</span><br><span class="line">    InputStream inputStream &#x3D; httpURLConnection.getInputStream();</span><br><span class="line">    BufferedReader bufferedReader &#x3D; new BufferedReader(new InputStreamReader(inputStream, UTF8));</span><br><span class="line">    StringBuffer stringBuffer &#x3D; new StringBuffer();</span><br><span class="line">    String line &#x3D; null;</span><br><span class="line">   </span><br><span class="line">    while((line &#x3D; bufferedReader.readLine()) !&#x3D; null) &#123;</span><br><span class="line">        stringBuffer.append(line);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String resp &#x3D; stringBuffer.toString();</span><br><span class="line">    if (stringBuffer !&#x3D; null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            bufferedReader.close();</span><br><span class="line">        &#125; catch (IOException var24) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    if (inputStream !&#x3D; null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; catch (IOException var23) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    if (outputStream !&#x3D; null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125; catch (IOException var22) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    if (certStream !&#x3D; null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            certStream.close();</span><br><span class="line">        &#125; catch (IOException var21) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    return resp;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; processResponseXml(String xmlStr) throws Exception &#123;</span><br><span class="line">    String RETURN_CODE &#x3D; &quot;return_code&quot;;</span><br><span class="line">    Map&lt;String, String&gt; respData &#x3D; WXPayUtil.xmlToMap(xmlStr);</span><br><span class="line">    if (respData.containsKey(RETURN_CODE)) &#123;</span><br><span class="line">        String return_code &#x3D; (String)respData.get(RETURN_CODE);</span><br><span class="line">        if (return_code.equals(&quot;FAIL&quot;)) &#123;</span><br><span class="line">            return respData;</span><br><span class="line">        &#125; else if (return_code.equals(&quot;SUCCESS&quot;)) &#123;</span><br><span class="line">            if (this.isResponseSignatureValid(respData)) &#123;</span><br><span class="line">                return respData;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                throw new Exception(String.format(&quot;Invalid sign value in XML: %s&quot;, xmlStr));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new Exception(String.format(&quot;return_code value %s is invalid in XML: %s&quot;, return_code, xmlStr));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new Exception(String.format(&quot;No &#96;return_code&#96; in XML: %s&quot;, xmlStr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; microPay(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.microPay(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; microPay(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;micropay&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;micropay&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; unifiedOrder(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.unifiedOrder(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; unifiedOrder(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;unifiedorder&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;unifiedorder&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; orderQuery(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.orderQuery(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; orderQuery(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;orderquery&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;orderquery&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; reverse(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.reverse(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; reverse(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;secapi&#x2F;pay&#x2F;reverse&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;secapi&#x2F;pay&#x2F;reverse&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; closeOrder(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.closeOrder(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; closeOrder(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;closeorder&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;closeorder&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; refund(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.refund(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; refund(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;secapi&#x2F;pay&#x2F;refund&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;secapi&#x2F;pay&#x2F;refund&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; refundQuery(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.refundQuery(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; refundQuery(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;refundquery&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;refundquery&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; downloadBill(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.downloadBill(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; downloadBill(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;downloadbill&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;downloadbill&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respStr &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs).trim();</span><br><span class="line">    Object ret;</span><br><span class="line">    if (respStr.indexOf(&quot;&lt;&quot;) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        ret &#x3D; WXPayUtil.xmlToMap(respStr);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ret &#x3D; new HashMap();</span><br><span class="line">        ((Map)ret).put(&quot;return_code&quot;, &quot;SUCCESS&quot;);</span><br><span class="line">        ((Map)ret).put(&quot;return_msg&quot;, &quot;ok&quot;);</span><br><span class="line">        ((Map)ret).put(&quot;data&quot;, respStr);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    return (Map)ret;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; report(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.report(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; report(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;payitil&#x2F;report&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;payitil&#x2F;report&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return WXPayUtil.xmlToMap(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; shortUrl(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.shortUrl(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; shortUrl(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;tools&#x2F;shorturl&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;tools&#x2F;shorturl&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; authCodeToOpenid(Map&lt;String, String&gt; reqData) throws Exception &#123;</span><br><span class="line">    return this.authCodeToOpenid(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">public Map&lt;String, String&gt; authCodeToOpenid(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception &#123;</span><br><span class="line">    String url;</span><br><span class="line">    if (this.useSandbox) &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;tools&#x2F;authcodetoopenid&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        url &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;tools&#x2F;authcodetoopenid&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    String respXml &#x3D; this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);</span><br><span class="line">    return this.processResponseXml(respXml);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-微信第三方转换工具"><a href="#2-微信第三方转换工具" class="headerlink" title="2 微信第三方转换工具"></a>2 微信第三方转换工具</h4><figure class="highlight plain"><figcaption><span>com.dnfly.core.WXPayConfig;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.w3c.dom.Document;</span><br><span class="line">import org.w3c.dom.Element;</span><br><span class="line">import org.w3c.dom.Node;</span><br><span class="line">import org.w3c.dom.NodeList;</span><br><span class="line"></span><br><span class="line">import javax.crypto.Mac;</span><br><span class="line">import javax.crypto.spec.SecretKeySpec;</span><br><span class="line">import javax.xml.parsers.DocumentBuilder;</span><br><span class="line">import javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line">import javax.xml.transform.Transformer;</span><br><span class="line">import javax.xml.transform.TransformerFactory;</span><br><span class="line">import javax.xml.transform.dom.DOMSource;</span><br><span class="line">import javax.xml.transform.stream.StreamResult;</span><br><span class="line">import java.io.ByteArrayInputStream;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.StringWriter;</span><br><span class="line">import java.security.MessageDigest;</span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class WXPayUtil &#123;</span><br><span class="line">    public WXPayUtil() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Map&lt;String, String&gt; xmlToMap(String strXML) throws Exception &#123;</span><br><span class="line">        Map&lt;String, String&gt; data &#x3D; new HashMap();</span><br><span class="line">        DocumentBuilderFactory documentBuilderFactory &#x3D; DocumentBuilderFactory.newInstance();</span><br><span class="line">        documentBuilderFactory.setExpandEntityReferences(false);</span><br><span class="line">        documentBuilderFactory.setFeature(&quot;http:&#x2F;&#x2F;javax.xml.XMLConstants&#x2F;feature&#x2F;secure-processing&quot;, true);</span><br><span class="line">        DocumentBuilder documentBuilder &#x3D; documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">        InputStream stream &#x3D; new ByteArrayInputStream(strXML.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">        Document doc &#x3D; documentBuilder.parse(stream);</span><br><span class="line">        doc.getDocumentElement().normalize();</span><br><span class="line">        NodeList nodeList &#x3D; doc.getDocumentElement().getChildNodes();</span><br><span class="line"></span><br><span class="line">        for(int idx &#x3D; 0; idx &lt; nodeList.getLength(); ++idx) &#123;</span><br><span class="line">            Node node &#x3D; nodeList.item(idx);</span><br><span class="line">            if (node.getNodeType() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                Element element &#x3D; (Element)node;</span><br><span class="line">                data.put(element.getNodeName(), element.getTextContent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            stream.close();</span><br><span class="line">        &#125; catch (Exception var10) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String mapToXml(Map&lt;String, String&gt; data) throws Exception &#123;</span><br><span class="line">        DocumentBuilderFactory documentBuilderFactory &#x3D; DocumentBuilderFactory.newInstance();</span><br><span class="line">        DocumentBuilder documentBuilder &#x3D; documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">        Document document &#x3D; documentBuilder.newDocument();</span><br><span class="line">        Element root &#x3D; document.createElement(&quot;xml&quot;);</span><br><span class="line">        document.appendChild(root);</span><br><span class="line">        Iterator var5 &#x3D; data.keySet().iterator();</span><br><span class="line"></span><br><span class="line">        while(var5.hasNext()) &#123;</span><br><span class="line">            String key &#x3D; (String)var5.next();</span><br><span class="line">            String value &#x3D; (String)data.get(key);</span><br><span class="line">            if (value &#x3D;&#x3D; null) &#123;</span><br><span class="line">                value &#x3D; &quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            value &#x3D; value.trim();</span><br><span class="line">            Element filed &#x3D; document.createElement(key);</span><br><span class="line">            filed.appendChild(document.createTextNode(value));</span><br><span class="line">            root.appendChild(filed);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TransformerFactory tf &#x3D; TransformerFactory.newInstance();</span><br><span class="line">        Transformer transformer &#x3D; tf.newTransformer();</span><br><span class="line">        DOMSource source &#x3D; new DOMSource(document);</span><br><span class="line">        transformer.setOutputProperty(&quot;encoding&quot;, &quot;UTF-8&quot;);</span><br><span class="line">        transformer.setOutputProperty(&quot;indent&quot;, &quot;yes&quot;);</span><br><span class="line">        StringWriter writer &#x3D; new StringWriter();</span><br><span class="line">        StreamResult result &#x3D; new StreamResult(writer);</span><br><span class="line">        transformer.transform(source, result);</span><br><span class="line">        String output &#x3D; writer.getBuffer().toString();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            writer.close();</span><br><span class="line">        &#125; catch (Exception var12) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String generateSignedXml(final Map&lt;String, String&gt; data, String key) throws Exception &#123;</span><br><span class="line">        return generateSignedXml(data, key, WXPayConstants.SignType.MD5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String generateSignedXml(final Map&lt;String, String&gt; data, String key, WXPayConstants.SignType signType) throws Exception &#123;</span><br><span class="line">        String sign &#x3D; generateSignature(data, key, signType);</span><br><span class="line">        data.put(&quot;sign&quot;, sign);</span><br><span class="line">        return mapToXml(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static boolean isSignatureValid(String xmlStr, String key) throws Exception &#123;</span><br><span class="line">        Map&lt;String, String&gt; data &#x3D; xmlToMap(xmlStr);</span><br><span class="line">        if (!data.containsKey(&quot;sign&quot;)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String sign &#x3D; (String)data.get(&quot;sign&quot;);</span><br><span class="line">            return generateSignature(data, key).equals(sign);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static boolean isSignatureValid(Map&lt;String, String&gt; data, String key) throws Exception &#123;</span><br><span class="line">        return isSignatureValid(data, key, WXPayConstants.SignType.MD5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static boolean isSignatureValid(Map&lt;String, String&gt; data, String key, WXPayConstants.SignType signType) throws Exception &#123;</span><br><span class="line">        if (!data.containsKey(&quot;sign&quot;)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String sign &#x3D; (String)data.get(&quot;sign&quot;);</span><br><span class="line">            return generateSignature(data, key, signType).equals(sign);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String generateSignature(final Map&lt;String, String&gt; data, String key) throws Exception &#123;</span><br><span class="line">        return generateSignature(data, key, WXPayConstants.SignType.MD5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String generateSignature(final Map&lt;String, String&gt; data, String key, WXPayConstants.SignType signType) throws Exception &#123;</span><br><span class="line">        Set&lt;String&gt; keySet &#x3D; data.keySet();</span><br><span class="line">        String[] keyArray &#x3D; keySet.toArray(new String[keySet.size()]);</span><br><span class="line">        Arrays.sort(keyArray);</span><br><span class="line">        StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">        for (String k : keyArray) &#123;</span><br><span class="line">            if (k.equals(WXPayConstants.FIELD_SIGN)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (data.get(k).trim().length() &gt; 0) &#x2F;&#x2F; 参数值为空，则不参与签名</span><br><span class="line">                sb.append(k).append(&quot;&#x3D;&quot;).append(data.get(k).trim()).append(&quot;&amp;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(&quot;key&#x3D;&quot;).append(key);</span><br><span class="line">        if (WXPayConstants.SignType.MD5.equals(signType)) &#123;</span><br><span class="line">            return MD5(sb.toString()).toUpperCase();</span><br><span class="line">        &#125;</span><br><span class="line">        else if (WXPayConstants.SignType.HMACSHA256.equals(signType)) &#123;</span><br><span class="line">            return HMACSHA256(sb.toString(), key);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            throw new Exception(String.format(&quot;Invalid sign_type: %s&quot;, signType));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String generateNonceStr() &#123;</span><br><span class="line">        return UUID.randomUUID().toString().replaceAll(&quot;-&quot;, &quot;&quot;).substring(0, 32);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String MD5(String data) throws Exception &#123;</span><br><span class="line">        MessageDigest md &#x3D; MessageDigest.getInstance(&quot;MD5&quot;);</span><br><span class="line">        byte[] array &#x3D; md.digest(data.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">        StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">        byte[] var4 &#x3D; array;</span><br><span class="line">        int var5 &#x3D; array.length;</span><br><span class="line"></span><br><span class="line">        for(int var6 &#x3D; 0; var6 &lt; var5; ++var6) &#123;</span><br><span class="line">            byte item &#x3D; var4[var6];</span><br><span class="line">            sb.append(Integer.toHexString(item &amp; 255 | 256).substring(1, 3));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return sb.toString().toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String HMACSHA256(String data, String key) throws Exception &#123;</span><br><span class="line">        Mac sha256_HMAC &#x3D; Mac.getInstance(&quot;HmacSHA256&quot;);</span><br><span class="line">        SecretKeySpec secret_key &#x3D; new SecretKeySpec(key.getBytes(&quot;UTF-8&quot;), &quot;HmacSHA256&quot;);</span><br><span class="line">        sha256_HMAC.init(secret_key);</span><br><span class="line">        byte[] array &#x3D; sha256_HMAC.doFinal(data.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">        StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">        byte[] var6 &#x3D; array;</span><br><span class="line">        int var7 &#x3D; array.length;</span><br><span class="line"></span><br><span class="line">        for(int var8 &#x3D; 0; var8 &lt; var7; ++var8) &#123;</span><br><span class="line">            byte item &#x3D; var6[var8];</span><br><span class="line">            sb.append(Integer.toHexString(item &amp; 255 | 256).substring(1, 3));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return sb.toString().toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-发送请求接口"><a href="#3-发送请求接口" class="headerlink" title="3  发送请求接口"></a>3  发送请求接口</h4><figure class="highlight plain"><figcaption><span>com.dnfly.core.WXPayConfig;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class WXPayConstants &#123;</span><br><span class="line">    public static final String FAIL &#x3D; &quot;FAIL&quot;;</span><br><span class="line">    public static final String SUCCESS &#x3D; &quot;SUCCESS&quot;;</span><br><span class="line">    public static final String HMACSHA256 &#x3D; &quot;HMAC-SHA256&quot;;</span><br><span class="line">    public static final String MD5 &#x3D; &quot;MD5&quot;;</span><br><span class="line">    public static final String FIELD_SIGN &#x3D; &quot;sign&quot;;</span><br><span class="line">    public static final String FIELD_SIGN_TYPE &#x3D; &quot;sign_type&quot;;</span><br><span class="line">    public static final String MICROPAY_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;micropay&quot;;</span><br><span class="line">    public static final String UNIFIEDORDER_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;unifiedorder&quot;;</span><br><span class="line">    public static final String ORDERQUERY_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;orderquery&quot;;</span><br><span class="line">    public static final String REVERSE_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;secapi&#x2F;pay&#x2F;reverse&quot;;</span><br><span class="line">    public static final String CLOSEORDER_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;closeorder&quot;;</span><br><span class="line">    public static final String REFUND_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;secapi&#x2F;pay&#x2F;refund&quot;;</span><br><span class="line">    public static final String REFUNDQUERY_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;refundquery&quot;;</span><br><span class="line">    public static final String DOWNLOADBILL_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;pay&#x2F;downloadbill&quot;;</span><br><span class="line">    public static final String REPORT_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;payitil&#x2F;report&quot;;</span><br><span class="line">    public static final String SHORTURL_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;tools&#x2F;shorturl&quot;;</span><br><span class="line">    public static final String AUTHCODETOOPENID_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;tools&#x2F;authcodetoopenid&quot;;</span><br><span class="line">    public static final String SANDBOX_MICROPAY_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;micropay&quot;;</span><br><span class="line">    public static final String SANDBOX_UNIFIEDORDER_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;unifiedorder&quot;;</span><br><span class="line">    public static final String SANDBOX_ORDERQUERY_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;orderquery&quot;;</span><br><span class="line">    public static final String SANDBOX_REVERSE_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;secapi&#x2F;pay&#x2F;reverse&quot;;</span><br><span class="line">    public static final String SANDBOX_CLOSEORDER_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;closeorder&quot;;</span><br><span class="line">    public static final String SANDBOX_REFUND_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;secapi&#x2F;pay&#x2F;refund&quot;;</span><br><span class="line">    public static final String SANDBOX_REFUNDQUERY_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;refundquery&quot;;</span><br><span class="line">    public static final String SANDBOX_DOWNLOADBILL_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;pay&#x2F;downloadbill&quot;;</span><br><span class="line">    public static final String SANDBOX_REPORT_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;payitil&#x2F;report&quot;;</span><br><span class="line">    public static final String SANDBOX_SHORTURL_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;tools&#x2F;shorturl&quot;;</span><br><span class="line">    public static final String SANDBOX_AUTHCODETOOPENID_URL &#x3D; &quot;https:&#x2F;&#x2F;api.mch.weixin.qq.com&#x2F;sandboxnew&#x2F;tools&#x2F;authcodetoopenid&quot;;</span><br><span class="line"></span><br><span class="line">    public WXPayConstants() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static enum SignType &#123;</span><br><span class="line">        MD5,</span><br><span class="line">        HMACSHA256;</span><br><span class="line"></span><br><span class="line">        private SignType() &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-配置接口"><a href="#4-配置接口" class="headerlink" title="4  配置接口"></a>4  配置接口</h4><figure class="highlight plain"><figcaption><span>com.dnfly.core.WXPayConfig;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import java.io.InputStream;</span><br><span class="line"></span><br><span class="line">public interface WXPayConfig &#123;</span><br><span class="line">    String getAppID();</span><br><span class="line"></span><br><span class="line">    String getMchID();</span><br><span class="line"></span><br><span class="line">    String getSubMchId();</span><br><span class="line"></span><br><span class="line">    String getKey();</span><br><span class="line"></span><br><span class="line">    InputStream getCertStream();</span><br><span class="line"></span><br><span class="line">    int getHttpConnectTimeoutMs();</span><br><span class="line"></span><br><span class="line">    int getHttpReadTimeoutMs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-创建微信支付的各种配置参数"><a href="#5-创建微信支付的各种配置参数" class="headerlink" title="5 创建微信支付的各种配置参数"></a>5 创建微信支付的各种配置参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">  import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;</span><br><span class="line">  import com.dnfly.core.WXPayConfig.WXPay;</span><br><span class="line">  import com.dnfly.core.WXPayConfig.WXPayConfig;</span><br><span class="line">  import com.dnfly.core.WXPayConfig.WXPayConstants;</span><br><span class="line">  import com.dnfly.core.WXPayConfig.WXPayUtil;</span><br><span class="line">  import com.jayway.jsonpath.DocumentContext;</span><br><span class="line">  import com.jayway.jsonpath.JsonPath;</span><br><span class="line">  import com.kapipo.common.ConstUtils;</span><br><span class="line">  import com.kapipo.common.Constant;</span><br><span class="line">  import com.kapipo.common.Util;</span><br><span class="line">  import com.kapipo.entity.model.OrderModel;</span><br><span class="line">  import com.kapipo.entity.model.PayModel;</span><br><span class="line">  import com.kapipo.entity.model.PayNotificationModel;</span><br><span class="line">  import lombok.extern.slf4j.Slf4j;</span><br><span class="line">  import lombok.val;</span><br><span class="line">  import org.apache.commons.lang3.RandomStringUtils;</span><br><span class="line">  import org.springframework.stereotype.Service;</span><br><span class="line">  import java.io.InputStream;</span><br><span class="line">  import java.util.HashMap;</span><br><span class="line">  import java.util.Map;</span><br><span class="line">  import javax.servlet.http.HttpServletRequest;</span><br><span class="line">  import org.apache.commons.io.IOUtils;</span><br><span class="line">  import org.apache.http.impl.io.EmptyInputStream;</span><br><span class="line">  import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">  import org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line">  @Slf4j</span><br><span class="line">  public class WxPayService &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  private static final String actionUnifiedOrder &#x3D; &quot;unifiedorder&quot; ;</span><br><span class="line">  private static final String actionRefund &#x3D; &quot;refund&quot; ; ;</span><br><span class="line">  private static final String actionRefundQuery &#x3D; &quot;refundquery&quot; ;</span><br><span class="line"></span><br><span class="line">  @Autowired</span><br><span class="line">  private IClientOrderService orderService;</span><br><span class="line"></span><br><span class="line">  @Autowired</span><br><span class="line">  private IClientPayService payService;</span><br><span class="line">  @Autowired</span><br><span class="line">  private PayNotificationService payNotificationService;</span><br><span class="line"></span><br><span class="line">  public WXPayConfig createConfig(String appId , String mchId, String key, InputStream cert)&#123;</span><br><span class="line">      WXPayConfig config &#x3D;  new WXPayConfig() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public String getAppID() &#123;</span><br><span class="line">              return appId;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public String getMchID() &#123;</span><br><span class="line">              return mchId;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public String getSubMchId() &#123;</span><br><span class="line">              return &quot;&quot;;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public String getKey() &#123;</span><br><span class="line">              return key;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public InputStream getCertStream() &#123;</span><br><span class="line">              return cert;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public int getHttpConnectTimeoutMs() &#123;</span><br><span class="line">              return 2000;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public int getHttpReadTimeoutMs() &#123;</span><br><span class="line">              return 10000;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      return config;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * @param name 订单名</span><br><span class="line">   * @param tradeType 交易类型，如 JSAPI</span><br><span class="line">   * @param openId 用户openId</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public Map&lt;String, String&gt; createOrderConfig( String name, String tradeType, String openId , String notifyUrl)  &#123;</span><br><span class="line">      HashMap&lt;String, String&gt; data &#x3D; new HashMap &lt;String, String&gt;();</span><br><span class="line">      data.put(&quot;_action&quot;, actionUnifiedOrder);</span><br><span class="line">      data.put(&quot;body&quot;, name);</span><br><span class="line">      data.put(&quot;trade_type&quot;, tradeType);</span><br><span class="line">      data.put(&quot;openid&quot;, openId);</span><br><span class="line">      data.put(&quot;notify_url&quot;, notifyUrl);</span><br><span class="line">      return data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   *创建退款配置</span><br><span class="line">   *&#x2F;</span><br><span class="line">  public Map&lt;String, String&gt; createRefundConfig(String paySn, Integer payMoney, String notifyUrl)  &#123;</span><br><span class="line">      HashMap&lt;String, String&gt; data &#x3D; new HashMap &lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">      data.put(&quot;_action&quot;, actionRefund);</span><br><span class="line">      data.put(&quot;out_trade_no&quot;, paySn);</span><br><span class="line">      data.put(&quot;total_fee&quot;, payMoney.toString());</span><br><span class="line">      data.put(&quot;notify_url&quot;, notifyUrl);</span><br><span class="line">      return data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; </span><br><span class="line">  @Transactional</span><br><span class="line">  public Map&lt;String, String&gt; bootstrap(WXPayConfig config, PayModel pay , Map&lt;String, String&gt; orderConfig) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">      if (pay.getStatus() &gt;&#x3D; Constant.PAY_STATUS_SUCCESS) &#123;</span><br><span class="line">          throw new FyException(&quot;订单已支付&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      String action &#x3D; orderConfig.get(&quot;_action&quot;);</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; prepare params</span><br><span class="line">      HashMap&lt;String, String&gt; mapOrderData &#x3D; new HashMap&lt;String, String&gt;();</span><br><span class="line">      mapOrderData.putAll(orderConfig);</span><br><span class="line">      mapOrderData.remove(&quot;_action&quot;);</span><br><span class="line">      switch (action) &#123;</span><br><span class="line">          case actionUnifiedOrder:</span><br><span class="line">              mapOrderData.put(&quot;total_fee&quot;, pay.getMoney().toString());</span><br><span class="line">              mapOrderData.put(&quot;out_trade_no&quot;, pay.getSn());</span><br><span class="line">              break;</span><br><span class="line"></span><br><span class="line">          case actionRefund:</span><br><span class="line">              mapOrderData.put(&quot;out_refund_no&quot;, pay.getSn());</span><br><span class="line">              mapOrderData.put(&quot;refund_fee&quot;, pay.getMoney().toString());</span><br><span class="line">              break;</span><br><span class="line">          default:</span><br><span class="line">              break;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; call api</span><br><span class="line">      WXPay wxPay &#x3D; new WXPay(config, WXPayConstants.SignType.HMACSHA256);</span><br><span class="line"></span><br><span class="line">      Map&lt;String, String&gt; response &#x3D; new HashMap&lt;String, String&gt;();</span><br><span class="line">      switch (action) &#123;</span><br><span class="line">          case actionUnifiedOrder :</span><br><span class="line">              response &#x3D; wxPay.unifiedOrder(mapOrderData);</span><br><span class="line">              break;</span><br><span class="line">          case actionRefund:</span><br><span class="line">              response &#x3D; wxPay.refund(mapOrderData);</span><br><span class="line">              break;</span><br><span class="line">          default:</span><br><span class="line">              break;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      log.info(&quot;response-info:&#123;&#125;&quot;, Util.jsonEncode(response));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; process</span><br><span class="line">      DocumentContext ctx &#x3D; JsonPath.parse(response);</span><br><span class="line">      String resultCode &#x3D; ConstUtils.readValue(ctx, &quot;$.return_code&quot;, String.class);</span><br><span class="line">      String outRefundNo &#x3D; ConstUtils.readValue(ctx, &quot;$.out_refund_no&quot;, String.class);</span><br><span class="line">      log.info(&quot;return_code:&#123;&#125;, out_refund_no:&#123;&#125;&quot;, resultCode, outRefundNo);</span><br><span class="line"></span><br><span class="line">      Map&lt;String, String&gt; mapData &#x3D; new HashMap&lt;String, String&gt;();</span><br><span class="line">      if (resultCode.equals(&quot;SUCCESS&quot;)) &#123;</span><br><span class="line">          if (action &#x3D;&#x3D; actionUnifiedOrder) &#123;</span><br><span class="line">                  Map&lt;String, String&gt; data &#x3D; processUnifiedOrderResponse(config, ctx);</span><br><span class="line">                  pay.setData(data.toString());</span><br><span class="line">                  mapData &#x3D; data;</span><br><span class="line">          &#125; else if (action &#x3D;&#x3D; actionRefund) &#123;</span><br><span class="line">                  pay.setStatus(Constant.PAY_STATUS_SUCCESS);</span><br><span class="line">                  orderService.saveRefund(pay.getTargetId(), outRefundNo);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">          payService.saveOrUpdate(pay);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">          payService.saveOrUpdate(pay);</span><br><span class="line">          val errCodeRes &#x3D; ConstUtils.readValue(ctx, &quot;$.return_msg&quot;, String.class);</span><br><span class="line">          throw new FyException(&quot;bootstrap fail&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      return mapData;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private Map&lt;String, String&gt; processUnifiedOrderResponse( WXPayConfig config, DocumentContext ctx)  &#123;</span><br><span class="line">      val prepayId &#x3D; ConstUtils.readValue(ctx, &quot;$.prepay_id&quot;, String.class);</span><br><span class="line"></span><br><span class="line">      Map&lt;String, String&gt; data &#x3D; new HashMap&lt;String, String&gt;();</span><br><span class="line">      data.put(&quot;appId&quot;, config.getAppID());</span><br><span class="line">      data.put(&quot;nonceStr&quot;, RandomStringUtils.randomAlphanumeric(16));</span><br><span class="line">      data.put(&quot;package&quot;, &quot;prepay_id&#x3D;&quot; + prepayId);</span><br><span class="line">      data.put(&quot;signType&quot;, &quot;HMAC-SHA256&quot;);</span><br><span class="line">      data.put(&quot;timeStamp&quot;, String.valueOf(System.currentTimeMillis() &#x2F; 1000L));</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">          data.put(&quot;paySign&quot;, WXPayUtil.generateSignature(data, config.getKey(), WXPayConstants.SignType.HMACSHA256));</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      return data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Transactional</span><br><span class="line">  public PayModel processNotify( WXPayConfig config , HttpServletRequest request) throws Exception &#123;</span><br><span class="line">      String rawContent &#x3D; IOUtils.toString(request.getInputStream(), &quot;UTF-8&quot;);</span><br><span class="line">      Map&lt;String, String&gt; data &#x3D; WXPayUtil.xmlToMap(rawContent);</span><br><span class="line"></span><br><span class="line">      if (data.isEmpty()) &#123;</span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!WXPayUtil.isSignatureValid(data, config.getKey(), WXPayConstants.SignType.HMACSHA256)) &#123;</span><br><span class="line"></span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!data.containsKey(&quot;result_code&quot;) || !data.containsKey(&quot;out_trade_no&quot;)) &#123;</span><br><span class="line"></span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      String result_code &#x3D; data.get(&quot;result_code&quot;);</span><br><span class="line">      String sn &#x3D; data.get(&quot;out_trade_no&quot;);</span><br><span class="line"></span><br><span class="line">      val pay &#x3D; payService.findBySn(sn);</span><br><span class="line">      if (pay &#x3D;&#x3D; null) &#123;</span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      pay.setData(data.toString());</span><br><span class="line"></span><br><span class="line">      if (result_code.equals(&quot;SUCCESS&quot;)) &#123;</span><br><span class="line">          pay.setStatus(Constant.PAY_STATUS_SUCCESS);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          pay.setStatus(Constant.PAY_STATUS_FAIL);</span><br><span class="line">      &#125;</span><br><span class="line">      payService.saveOrUpdate(pay);</span><br><span class="line">      &#x2F;&#x2F; savePayNotification</span><br><span class="line">      this.saveNotification(data, pay);</span><br><span class="line"></span><br><span class="line">      return pay;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Transactional</span><br><span class="line">  public PayModel processRefundNotify( WXPayConfig config , HttpServletRequest request) throws Exception &#123;</span><br><span class="line">      String rawContent &#x3D; IOUtils.toString(request.getInputStream(), &quot;UTF-8&quot;);</span><br><span class="line">      Map&lt;String, String&gt; data &#x3D; WXPayUtil.xmlToMap(rawContent);</span><br><span class="line">      log.info(&quot;退款回调处理数据----data:&#123;&#125;&quot;, Util.jsonEncode(data));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      if (data.isEmpty()) &#123;</span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!WXPayUtil.isSignatureValid(data, config.getKey(), WXPayConstants.SignType.HMACSHA256)) &#123;</span><br><span class="line"></span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!data.containsKey(&quot;refund_status&quot;) || !data.containsKey(&quot;out_refund_no&quot;)) &#123;</span><br><span class="line"></span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      String result_code &#x3D; data.get(&quot;refund_status&quot;);</span><br><span class="line">      String sn &#x3D; data.get(&quot;out_refund_no&quot;);</span><br><span class="line"></span><br><span class="line">      val pay &#x3D; payService.findBySn(sn);</span><br><span class="line">      log.info(&quot;退款回调的pay是否存在:&#123;&#125;&quot;, Util.jsonEncode(pay));</span><br><span class="line"></span><br><span class="line">      if (pay &#x3D;&#x3D; null) &#123;</span><br><span class="line">          return null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      pay.setData(data.toString());</span><br><span class="line"></span><br><span class="line">      if (result_code.equals(&quot;SUCCESS&quot;)) &#123;</span><br><span class="line">          pay.setStatus(Constant.PAY_STATUS_SUCCESS);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          pay.setStatus(Constant.PAY_STATUS_FAIL);</span><br><span class="line">      &#125;</span><br><span class="line">      payService.saveOrUpdate(pay);</span><br><span class="line">      &#x2F;&#x2F; savePayNotification</span><br><span class="line">      this.saveNotification(data, pay);</span><br><span class="line"></span><br><span class="line">      return pay;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public WXPayConfig createConfigData(String appId, String mchId, String subMchId, String mchKey, EmptyInputStream instance) &#123;</span><br><span class="line">      WXPayConfig config &#x3D;  new WXPayConfig() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public String getAppID() &#123;</span><br><span class="line">              return appId;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public String getMchID() &#123;</span><br><span class="line">              return mchId;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public String getSubMchId() &#123;</span><br><span class="line">              return subMchId;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public String getKey() &#123;</span><br><span class="line">              return mchKey;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public InputStream getCertStream() &#123;</span><br><span class="line">              return instance;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public int getHttpConnectTimeoutMs() &#123;</span><br><span class="line">              return 2000;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          @Override</span><br><span class="line">          public int getHttpReadTimeoutMs() &#123;</span><br><span class="line">              return 10000;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      return config;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" target="_blank" rel="noopener"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" target="_blank" rel="noopener"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>binbin</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/" title="微信">http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless stating additionally.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/06/30/mysql/" rel="prev" title="mysql 部分"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">mysql 部分</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/06/29/hello-world/" rel="next" title="Hello World"><span class="post-nav-text">Hello World</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" href="https://github.com/YunYouJun/yunyoujun.github.io/issues?q=is:issue+微信" target="_blank" rel="noopener">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> binbin</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v4.2.1</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v0.9.1</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script></body></html>