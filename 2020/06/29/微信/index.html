<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="binbin"><meta name="copyright" content="binbin"><meta name="generator" content="Hexo 4.2.1"><meta name="theme" content="hexo-theme-yun"><title>微信 | 随便写点</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;family=Source+Code+Pro&amp;display=swap" media="none" onload="this.media='all'"><script src="//at.alicdn.com/t/font_1140697_pem9yni52s.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"root":"/","title":"斌斌小站","version":"0.9.1","anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="微信支付1 首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)2 微信支付公众方法import com.alibaba.fastjson.JSONObject; import lombok.extern.slf4j.Slf4j; import org.apache.commons.lang3.StringUtils; import or">
<meta property="og:type" content="article">
<meta property="og:title" content="微信">
<meta property="og:url" content="http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/index.html">
<meta property="og:site_name" content="随便写点">
<meta property="og:description" content="微信支付1 首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)2 微信支付公众方法import com.alibaba.fastjson.JSONObject; import lombok.extern.slf4j.Slf4j; import org.apache.commons.lang3.StringUtils; import or">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-06-29T14:34:47.000Z">
<meta property="article:modified_time" content="2020-07-01T13:29:19.870Z">
<meta property="article:author" content="binbin">
<meta name="twitter:card" content="summary"></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script defer src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="binbin"><img width="96" loading="lazy" src="https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJx8aJMTicIKEcWB3sltRib2jUSopeIrialsGfcpBHAE3jPs4raImlQCCw7YAIZaq5OaKkwoicRSMcG5Q/132" alt="binbin"></a><div class="site-author-name"><a href="/about/">binbin</a></div><a class="site-name" href="/about/site.html">随便写点</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">0</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">0</span></a></div><a class="site-state-item hty-icon-button" href="https://yun.yunyoujun.cn" target="_blank" rel="noopener" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=1174437797&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/iamapb/iamapb.github.io" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/jizhideyunyoujun" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.douban.com/people/yunyoujun/" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=247102977" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/yunyoujun/" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#微信支付"><span class="toc-number">1.</span> <span class="toc-text">微信支付</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-首先获取-appid-appSecret-微信公众平台申请的小程序可以获取-mchId-微信商户号可以获得"><span class="toc-number">1.1.</span> <span class="toc-text">1 首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-微信支付公众方法"><span class="toc-number">1.2.</span> <span class="toc-text">2 微信支付公众方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#"><span class="toc-number">2.</span> <span class="toc-text">}</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#-1"><span class="toc-number">3.</span> <span class="toc-text">}</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="binbin"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="随便写点"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">微信</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2020-06-29 22:34:47" itemprop="dateCreated datePublished" datetime="2020-06-29T22:34:47+08:00">2020-06-29</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2020-07-01 21:29:19" itemprop="dateModified" datetime="2020-07-01T21:29:19+08:00">2020-07-01</time></div><div class="post-classify"></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content post-markdown"><h2 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a>微信支付</h2><h3 id="1-首先获取-appid-appSecret-微信公众平台申请的小程序可以获取-mchId-微信商户号可以获得"><a href="#1-首先获取-appid-appSecret-微信公众平台申请的小程序可以获取-mchId-微信商户号可以获得" class="headerlink" title="1 首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)"></a>1 首先获取 appid appSecret(微信公众平台申请的小程序可以获取) mchId (微信商户号可以获得)</h3><h3 id="2-微信支付公众方法"><a href="#2-微信支付公众方法" class="headerlink" title="2 微信支付公众方法"></a>2 微信支付公众方法</h3><pre><code>import com.alibaba.fastjson.JSONObject;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.core.io.ClassPathResource;

import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.KeyManagerFactory;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManager;
import java.io.*;
import java.net.HttpURLConnection;
import java.net.URL;
import java.security.KeyStore;
import java.security.SecureRandom;
import java.util.HashMap;
import java.util.Map;

@Slf4j
public class WXPay {
private WXPayConfig config;
private WXPayConstants.SignType signType;
private boolean useSandbox;

public WXPay(final WXPayConfig config) {
    this(config, WXPayConstants.SignType.MD5, false);
}

public WXPay(final WXPayConfig config, final WXPayConstants.SignType signType) {
    this(config, signType, false);
}

public WXPay(final WXPayConfig config, final WXPayConstants.SignType signType, final boolean useSandbox) {
    this.config = config;
    this.signType = signType;
    this.useSandbox = useSandbox;
}

public Map&lt;String, String&gt; fillRequestData(Map&lt;String, String&gt; reqData) throws Exception {
    reqData.put(&quot;appid&quot;, this.config.getAppID());
    reqData.put(&quot;mch_id&quot;, this.config.getMchID());
    if (StringUtils.isNotEmpty(this.config.getSubMchId())) {
        reqData.put(&quot;sub_mch_id&quot;, this.config.getSubMchId());
    }

    reqData.put(&quot;nonce_str&quot;, WXPayUtil.generateNonceStr());
    if (WXPayConstants.SignType.MD5.equals(this.signType)) {
        reqData.put(&quot;sign_type&quot;, &quot;MD5&quot;);
    } else if (WXPayConstants.SignType.HMACSHA256.equals(this.signType)) {
        reqData.put(&quot;sign_type&quot;, &quot;HMAC-SHA256&quot;);
    }

    reqData.put(&quot;sign&quot;, WXPayUtil.generateSignature(reqData, this.config.getKey(), this.signType));
    return reqData;
}

public boolean isResponseSignatureValid(Map&lt;String, String&gt; reqData) throws Exception {
    return WXPayUtil.isSignatureValid(reqData, this.config.getKey(), this.signType);
}

public boolean isPayResultNotifySignatureValid(Map&lt;String, String&gt; reqData) throws Exception {
    String signTypeInData = (String)reqData.get(&quot;sign_type&quot;);
    WXPayConstants.SignType signType;
    if (signTypeInData == null) {
        signType = WXPayConstants.SignType.MD5;
    } else {
        signTypeInData = signTypeInData.trim();
        if (signTypeInData.length() == 0) {
            signType = WXPayConstants.SignType.MD5;
        } else if (&quot;MD5&quot;.equals(signTypeInData)) {
            signType = WXPayConstants.SignType.MD5;
        } else {
            if (!&quot;HMAC-SHA256&quot;.equals(signTypeInData)) {
                throw new Exception(String.format(&quot;Unsupported sign_type: %s&quot;, signTypeInData));
            }

            signType = WXPayConstants.SignType.HMACSHA256;
        }
    }

    return WXPayUtil.isSignatureValid(reqData, this.config.getKey(), signType);
}

public String requestWithoutCert(String strUrl, Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String UTF8 = &quot;UTF-8&quot;;
    String reqBody = WXPayUtil.mapToXml(reqData);
    URL httpUrl = new URL(strUrl);
    HttpURLConnection httpURLConnection = (HttpURLConnection)httpUrl.openConnection();
    httpURLConnection.setDoOutput(true);
    httpURLConnection.setRequestMethod(&quot;POST&quot;);
    httpURLConnection.setConnectTimeout(connectTimeoutMs);
    httpURLConnection.setReadTimeout(readTimeoutMs);
    httpURLConnection.connect();
    OutputStream outputStream = httpURLConnection.getOutputStream();
    outputStream.write(reqBody.getBytes(UTF8));
    InputStream inputStream = httpURLConnection.getInputStream();
    BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream, UTF8));
    StringBuffer stringBuffer = new StringBuffer();
    String line = null;

    while((line = bufferedReader.readLine()) != null) {
        stringBuffer.append(line).append(&quot;\n&quot;);
    }

    String resp = stringBuffer.toString();
    if (stringBuffer != null) {
        try {
            bufferedReader.close();
        } catch (IOException var18) {
            var18.printStackTrace();
        }
    }

    if (inputStream != null) {
        try {
            inputStream.close();
        } catch (IOException var17) {
            var17.printStackTrace();
        }
    }

    if (outputStream != null) {
        try {
            outputStream.close();
        } catch (IOException var16) {
            var16.printStackTrace();
        }
    }

    return resp;
}

public String requestWithCert(String strUrl, Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String UTF8 = &quot;UTF-8&quot;;
    String reqBody = WXPayUtil.mapToXml(reqData);
    URL httpUrl = new URL(strUrl);
    char[] password = this.config.getMchID().toCharArray();
    InputStream certStream = new ClassPathResource(&quot;wxpay/apiclient_cert.p12&quot;).getInputStream();
    KeyStore ks = KeyStore.getInstance(&quot;PKCS12&quot;);
    ks.load(certStream, password);
    KeyManagerFactory kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());
    kmf.init(ks, password);
    SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);
    sslContext.init(kmf.getKeyManagers(), (TrustManager[])null, new SecureRandom());
    HttpsURLConnection.setDefaultSSLSocketFactory(sslContext.getSocketFactory());
    HttpURLConnection httpURLConnection = (HttpURLConnection)httpUrl.openConnection();
    httpURLConnection.setDoOutput(true);
    httpURLConnection.setRequestMethod(&quot;POST&quot;);
    httpURLConnection.setConnectTimeout(connectTimeoutMs);
    httpURLConnection.setReadTimeout(readTimeoutMs);
    httpURLConnection.connect();
    OutputStream outputStream = httpURLConnection.getOutputStream();
    outputStream.write(reqBody.getBytes(UTF8));
    InputStream inputStream = httpURLConnection.getInputStream();
    BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream, UTF8));
    StringBuffer stringBuffer = new StringBuffer();
    String line = null;

    while((line = bufferedReader.readLine()) != null) {
        stringBuffer.append(line);
    }

    String resp = stringBuffer.toString();
    if (stringBuffer != null) {
        try {
            bufferedReader.close();
        } catch (IOException var24) {
        }
    }

    if (inputStream != null) {
        try {
            inputStream.close();
        } catch (IOException var23) {
        }
    }

    if (outputStream != null) {
        try {
            outputStream.close();
        } catch (IOException var22) {
        }
    }

    if (certStream != null) {
        try {
            certStream.close();
        } catch (IOException var21) {
        }
    }

    return resp;
}

public Map&lt;String, String&gt; processResponseXml(String xmlStr) throws Exception {
    String RETURN_CODE = &quot;return_code&quot;;
    Map&lt;String, String&gt; respData = WXPayUtil.xmlToMap(xmlStr);
    if (respData.containsKey(RETURN_CODE)) {
        String return_code = (String)respData.get(RETURN_CODE);
        if (return_code.equals(&quot;FAIL&quot;)) {
            return respData;
        } else if (return_code.equals(&quot;SUCCESS&quot;)) {
            if (this.isResponseSignatureValid(respData)) {
                return respData;
            } else {
                throw new Exception(String.format(&quot;Invalid sign value in XML: %s&quot;, xmlStr));
            }
        } else {
            throw new Exception(String.format(&quot;return_code value %s is invalid in XML: %s&quot;, return_code, xmlStr));
        }
    } else {
        throw new Exception(String.format(&quot;No `return_code` in XML: %s&quot;, xmlStr));
    }
}

public Map&lt;String, String&gt; microPay(Map&lt;String, String&gt; reqData) throws Exception {
    return this.microPay(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; microPay(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/pay/micropay&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/pay/micropay&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; unifiedOrder(Map&lt;String, String&gt; reqData) throws Exception {
    return this.unifiedOrder(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; unifiedOrder(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/pay/unifiedorder&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/pay/unifiedorder&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; orderQuery(Map&lt;String, String&gt; reqData) throws Exception {
    return this.orderQuery(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; orderQuery(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/pay/orderquery&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/pay/orderquery&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; reverse(Map&lt;String, String&gt; reqData) throws Exception {
    return this.reverse(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; reverse(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/secapi/pay/reverse&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/secapi/pay/reverse&quot;;
    }

    String respXml = this.requestWithCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; closeOrder(Map&lt;String, String&gt; reqData) throws Exception {
    return this.closeOrder(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; closeOrder(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/pay/closeorder&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/pay/closeorder&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; refund(Map&lt;String, String&gt; reqData) throws Exception {
    return this.refund(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; refund(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/secapi/pay/refund&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/secapi/pay/refund&quot;;
    }

    String respXml = this.requestWithCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; refundQuery(Map&lt;String, String&gt; reqData) throws Exception {
    return this.refundQuery(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; refundQuery(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/pay/refundquery&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/pay/refundquery&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; downloadBill(Map&lt;String, String&gt; reqData) throws Exception {
    return this.downloadBill(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; downloadBill(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/pay/downloadbill&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/pay/downloadbill&quot;;
    }

    String respStr = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs).trim();
    Object ret;
    if (respStr.indexOf(&quot;&lt;&quot;) == 0) {
        ret = WXPayUtil.xmlToMap(respStr);
    } else {
        ret = new HashMap();
        ((Map)ret).put(&quot;return_code&quot;, &quot;SUCCESS&quot;);
        ((Map)ret).put(&quot;return_msg&quot;, &quot;ok&quot;);
        ((Map)ret).put(&quot;data&quot;, respStr);
    }

    return (Map)ret;
}

public Map&lt;String, String&gt; report(Map&lt;String, String&gt; reqData) throws Exception {
    return this.report(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; report(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/payitil/report&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/payitil/report&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return WXPayUtil.xmlToMap(respXml);
}

public Map&lt;String, String&gt; shortUrl(Map&lt;String, String&gt; reqData) throws Exception {
    return this.shortUrl(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; shortUrl(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/tools/shorturl&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/tools/shorturl&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}

public Map&lt;String, String&gt; authCodeToOpenid(Map&lt;String, String&gt; reqData) throws Exception {
    return this.authCodeToOpenid(reqData, this.config.getHttpConnectTimeoutMs(), this.config.getHttpReadTimeoutMs());
}

public Map&lt;String, String&gt; authCodeToOpenid(Map&lt;String, String&gt; reqData, int connectTimeoutMs, int readTimeoutMs) throws Exception {
    String url;
    if (this.useSandbox) {
        url = &quot;https://api.mch.weixin.qq.com/sandboxnew/tools/authcodetoopenid&quot;;
    } else {
        url = &quot;https://api.mch.weixin.qq.com/tools/authcodetoopenid&quot;;
    }

    String respXml = this.requestWithoutCert(url, this.fillRequestData(reqData), connectTimeoutMs, readTimeoutMs);
    return this.processResponseXml(respXml);
}</code></pre><h2 id=""><a href="#" class="headerlink" title="}"></a>}</h2><hr>
<p>package com.kapipo.service.client;</p>
<pre><code>import com.alibaba.fastjson.JSONObject;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.dnfly.core.WXPayConfig.WXPay;
import com.dnfly.core.WXPayConfig.WXPayConfig;
import com.dnfly.core.WXPayConfig.WXPayConstants;
import com.dnfly.core.WXPayConfig.WXPayUtil;
import com.dnfly.core.common.exception.FyException;
import com.jayway.jsonpath.DocumentContext;
import com.jayway.jsonpath.JsonPath;
import com.kapipo.common.ConstUtils;
import com.kapipo.common.Constant;
import com.kapipo.common.Util;
import com.kapipo.entity.model.OrderModel;
import com.kapipo.entity.model.PayModel;
import com.kapipo.entity.model.PayNotificationModel;
import lombok.extern.slf4j.Slf4j;
import lombok.val;
import org.apache.commons.lang3.RandomStringUtils;
import org.springframework.stereotype.Service;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;
import javax.servlet.http.HttpServletRequest;
import org.apache.commons.io.IOUtils;
import org.apache.http.impl.io.EmptyInputStream;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;</code></pre><p>@Service(“WxPayService”)<br>@Slf4j<br>public class WxPayService {</p>
<pre><code>private static final String actionUnifiedOrder = &quot;unifiedorder&quot; ;
private static final String actionRefund = &quot;refund&quot; ; ;
private static final String actionRefundQuery = &quot;refundquery&quot; ;

@Autowired
private IClientOrderService orderService;

@Autowired
private IClientPayService payService;
@Autowired
private PayNotificationService payNotificationService;

public WXPayConfig createConfig(String appId , String mchId, String key, InputStream cert){
    WXPayConfig config =  new WXPayConfig() {
        @Override
        public String getAppID() {
            return appId;
        }

        @Override
        public String getMchID() {
            return mchId;
        }

        @Override
        public String getSubMchId() {
            return &quot;&quot;;
        }

        @Override
        public String getKey() {
            return key;
        }

        @Override
        public InputStream getCertStream() {
            return cert;
        }

        @Override
        public int getHttpConnectTimeoutMs() {
            return 2000;
        }

        @Override
        public int getHttpReadTimeoutMs() {
            return 10000;
        }
    };
    return config;
}



/**
 * @param name 订单名
 * @param tradeType 交易类型，如 JSAPI
 * @param openId 用户openId
 */
public Map&lt;String, String&gt; createOrderConfig( String name, String tradeType, String openId , String notifyUrl)  {
    HashMap&lt;String, String&gt; data = new HashMap &lt;String, String&gt;();
    data.put(&quot;_action&quot;, actionUnifiedOrder);
    data.put(&quot;body&quot;, name);
    data.put(&quot;trade_type&quot;, tradeType);
    data.put(&quot;openid&quot;, openId);
    data.put(&quot;notify_url&quot;, notifyUrl);
    return data;
}

/**
 *创建退款配置
 */
public Map&lt;String, String&gt; createRefundConfig(String paySn, Integer payMoney, String notifyUrl)  {
    HashMap&lt;String, String&gt; data = new HashMap &lt;String, String&gt;();

    data.put(&quot;_action&quot;, actionRefund);
    data.put(&quot;out_trade_no&quot;, paySn);
    data.put(&quot;total_fee&quot;, payMoney.toString());</code></pre><p>//        data.put(“notify_url”, notifyUrl);<br>        return data;<br>    }</p>
<pre><code>@Transactional
public Map&lt;String, String&gt; bootstrap(WXPayConfig config, PayModel pay , Map&lt;String, String&gt; orderConfig) throws Exception {

    if (pay.getStatus() &gt;= Constant.PAY_STATUS_SUCCESS) {
        throw new FyException(&quot;订单已支付&quot;);
    }

    String action = orderConfig.get(&quot;_action&quot;);

    // prepare params
    HashMap&lt;String, String&gt; mapOrderData = new HashMap&lt;String, String&gt;();
    mapOrderData.putAll(orderConfig);
    mapOrderData.remove(&quot;_action&quot;);
    switch (action) {
        case actionUnifiedOrder:
            mapOrderData.put(&quot;total_fee&quot;, pay.getMoney().toString());
            mapOrderData.put(&quot;out_trade_no&quot;, pay.getSn());
            break;

        case actionRefund:
            mapOrderData.put(&quot;out_refund_no&quot;, pay.getSn());
            mapOrderData.put(&quot;refund_fee&quot;, pay.getMoney().toString());
            break;
        default:
            break;
    }

    // call api
    WXPay wxPay = new WXPay(config, WXPayConstants.SignType.HMACSHA256);

    Map&lt;String, String&gt; response = new HashMap&lt;String, String&gt;();
    switch (action) {
        case actionUnifiedOrder :
            response = wxPay.unifiedOrder(mapOrderData);
            break;
        case actionRefund:
            response = wxPay.refund(mapOrderData);
            break;
        default:
            break;

    }

    log.info(&quot;response-info:{}&quot;, Util.jsonEncode(response));



    // process
    DocumentContext ctx = JsonPath.parse(response);
    String resultCode = ConstUtils.readValue(ctx, &quot;$.return_code&quot;, String.class);
    String outRefundNo = ConstUtils.readValue(ctx, &quot;$.out_refund_no&quot;, String.class);
    log.info(&quot;return_code:{}, out_refund_no:{}&quot;, resultCode, outRefundNo);

    Map&lt;String, String&gt; mapData = new HashMap&lt;String, String&gt;();
    if (resultCode.equals(&quot;SUCCESS&quot;)) {
        if (action == actionUnifiedOrder) {
                Map&lt;String, String&gt; data = processUnifiedOrderResponse(config, ctx);
                pay.setData(data.toString());
                mapData = data;
        } else if (action == actionRefund) {
                pay.setStatus(Constant.PAY_STATUS_SUCCESS);
                orderService.saveRefund(pay.getTargetId(), outRefundNo);
        } else {

        }
        payService.saveOrUpdate(pay);
        } else {
        payService.saveOrUpdate(pay);
        val errCodeRes = ConstUtils.readValue(ctx, &quot;$.return_msg&quot;, String.class);
        throw new FyException(&quot;bootstrap fail&quot;);
    }
    return mapData;
}

private Map&lt;String, String&gt; processUnifiedOrderResponse( WXPayConfig config, DocumentContext ctx)  {
    val prepayId = ConstUtils.readValue(ctx, &quot;$.prepay_id&quot;, String.class);

    Map&lt;String, String&gt; data = new HashMap&lt;String, String&gt;();
    data.put(&quot;appId&quot;, config.getAppID());
    data.put(&quot;nonceStr&quot;, RandomStringUtils.randomAlphanumeric(16));
    data.put(&quot;package&quot;, &quot;prepay_id=&quot; + prepayId);
    data.put(&quot;signType&quot;, &quot;HMAC-SHA256&quot;);
    data.put(&quot;timeStamp&quot;, String.valueOf(System.currentTimeMillis() / 1000L));

    try {
        data.put(&quot;paySign&quot;, WXPayUtil.generateSignature(data, config.getKey(), WXPayConstants.SignType.HMACSHA256));
    } catch (Exception e) {
        e.printStackTrace();
    }
    return data;
}

@Transactional
public PayModel processNotify( WXPayConfig config , HttpServletRequest request) throws Exception {
    String rawContent = IOUtils.toString(request.getInputStream(), &quot;UTF-8&quot;);
    Map&lt;String, String&gt; data = WXPayUtil.xmlToMap(rawContent);

    if (data.isEmpty()) {
        return null;
    }

    if (!WXPayUtil.isSignatureValid(data, config.getKey(), WXPayConstants.SignType.HMACSHA256)) {

        return null;
    }

    if (!data.containsKey(&quot;result_code&quot;) || !data.containsKey(&quot;out_trade_no&quot;)) {

        return null;
    }

    String result_code = data.get(&quot;result_code&quot;);
    String sn = data.get(&quot;out_trade_no&quot;);

    val pay = payService.findBySn(sn);
    if (pay == null) {
        return null;
    }

    pay.setData(data.toString());

    if (result_code.equals(&quot;SUCCESS&quot;)) {
        pay.setStatus(Constant.PAY_STATUS_SUCCESS);
    } else {
        pay.setStatus(Constant.PAY_STATUS_FAIL);
    }
    payService.saveOrUpdate(pay);
    // savePayNotification
    this.saveNotification(data, pay);

    return pay;
}

@Transactional
public PayModel processRefundNotify( WXPayConfig config , HttpServletRequest request) throws Exception {
    String rawContent = IOUtils.toString(request.getInputStream(), &quot;UTF-8&quot;);
    Map&lt;String, String&gt; data = WXPayUtil.xmlToMap(rawContent);
    log.info(&quot;退款回调处理数据----data:{}&quot;, Util.jsonEncode(data));


    if (data.isEmpty()) {
        return null;
    }

    if (!WXPayUtil.isSignatureValid(data, config.getKey(), WXPayConstants.SignType.HMACSHA256)) {

        return null;
    }

    if (!data.containsKey(&quot;refund_status&quot;) || !data.containsKey(&quot;out_refund_no&quot;)) {

        return null;
    }

    String result_code = data.get(&quot;refund_status&quot;);
    String sn = data.get(&quot;out_refund_no&quot;);

    val pay = payService.findBySn(sn);
    log.info(&quot;退款回调的pay是否存在:{}&quot;, Util.jsonEncode(pay));

    if (pay == null) {
        return null;
    }

    pay.setData(data.toString());

    if (result_code.equals(&quot;SUCCESS&quot;)) {
        pay.setStatus(Constant.PAY_STATUS_SUCCESS);
    } else {
        pay.setStatus(Constant.PAY_STATUS_FAIL);
    }
    payService.saveOrUpdate(pay);
    // savePayNotification
    this.saveNotification(data, pay);

    return pay;
}

private void saveNotification(Map&lt;String, String&gt; data , PayModel pay) {
     PayNotificationModel model = new PayNotificationModel();
    model.setSn(pay.getSn());
    model.setPayId(pay.getId());
    model.setChannel(pay.getChannel());
    model.setTargetType(pay.getTargetType());
    model.setTargetId(pay.getTargetId());
    model.setData(com.alibaba.fastjson.JSONObject.toJSONString(data));
    payNotificationService.saveOrUpdate(model);
}

public WXPayConfig createConfigData(String appId, String mchId, String subMchId, String mchKey, EmptyInputStream instance) {
    WXPayConfig config =  new WXPayConfig() {
        @Override
        public String getAppID() {
            return appId;
        }

        @Override
        public String getMchID() {
            return mchId;
        }

        @Override
        public String getSubMchId() {
            return subMchId;
        }

        @Override
        public String getKey() {
            return mchKey;
        }

        @Override
        public InputStream getCertStream() {
            return instance;
        }

        @Override
        public int getHttpConnectTimeoutMs() {
            return 2000;
        }

        @Override
        public int getHttpReadTimeoutMs() {
            return 10000;
        }
    };
    return config;
}</code></pre><h2 id="-1"><a href="#-1" class="headerlink" title="}"></a>}</h2></div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" target="_blank" rel="noopener"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/alipay-qrcode.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" target="_blank" rel="noopener"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/donate/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>binbin</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/" title="微信">http://yoursite.com/2020/06/29/%E5%BE%AE%E4%BF%A1/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless stating additionally.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2020/06/30/mysql/" rel="prev" title="mysql 部分"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">mysql 部分</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2020/06/29/hello-world/" rel="next" title="Hello World"><span class="post-nav-text">Hello World</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" href="https://github.com/YunYouJun/yunyoujun.github.io/issues?q=is:issue+微信" target="_blank" rel="noopener">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2020 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> binbin</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v4.2.1</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v0.9.1</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script></body></html>